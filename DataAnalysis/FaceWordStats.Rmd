---
title: "Face Word Projects -- Data Analysis"
author: "[Haiyang Jin](https://haiyangjin.github.io/)"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: false
      smooth_scroll: false
    includes:
      after_body: Utilities/footer.html
---

# Preparations
```{r preparation}
# load library
library(tidyverse)
library(afex)
library(lme4)
library(lmerTest)
library(emmeans)

```

# Load and clean data 
```{r assign filenames}
# assign filenames
fn_loc <- "FaceWord_Loc_Univariate.csv"
fn_univar <- "FaceWord_Univariate.csv"
fn_cosmo <- "FaceWord_CosmoMVPA.csv"

# set the order of levels in factors
locOrder <- c("face", "object", "word", "scrambled")

facewordOrder <- c("face", "word")
wordsOrder <- c("Chinese", "English")
layoutOrder <- c("intact", "exchange", "top", "bottom")

pairOrder_E1 <- c("face_intact-word_intact",
                  "face_intact-face_exchange",
                  "face_top-face_bottom",
                  "word_intact-word_exchange",
                  "word_top-word_bottom")
pairOrder_E2 <- c("Chinese_intact-English_intact",
                  "Chinese_intact-Chinese_exchange",
                  "Chinese_top-Chinese_bottom",
                  "English_intact-English_exchange",
                  "English_top-English_bottom")

```

```{r setting for plots}
# set up the theme for plot and rainclound plot
# load all the R files in Utilities/
sapply(list.files('Utilities', "*.R", full.names = TRUE, recursive = TRUE), source)

activationUL <- 2.75

```

## Data from localizer scans
```{r load data file from localizer scans for univerate analysis}
# load data file from localizer scans for univerate analysis
df_loc <- read_csv(fn_loc)

str(df_loc)
```

```{r clean the loc data}
df_clean_loc <- {
  df_loc %>% 
    mutate(Conditions = factor(Conditions, levels = locOrder)) %>% # convert Conditions to factors
    select(ExpCode, ROI, SubjCode, Conditions, Resp) 
}

str(df_clean_loc)
```

### ROI information
```{r roi information}
df_loc %>% 
  select(ExpCode, ROI, SubjCode, nVertices, LabelSize) %>% 
  distinct()
```

## Data from functional scans for univarite analysis
```{r load data file for univariate analysis}
# load data file from functional scans for univerate analysis
df_univar <- read_csv(fn_univar)

str(df_univar)
```

```{r clean the univariate data}
df_clean_univar <- {
  df_univar %>% 
    separate(Conditions, c("FaceWord", "Layout"), "_") %>% # separate the conditions into two IVs
    mutate(# FaceWord = as.factor(FaceWord),
           Layout = factor(Layout, levels = layoutOrder)) %>% # convert the two IVs to factors
    select(ExpCode, ROI, SubjCode, FaceWord, Layout, Resp) 
}

str(df_clean_univar)
```

```{r aggregate data for running anova}
df_univar_agg <- {
  df_clean_univar %>% 
    group_by(ExpCode, ROI, SubjCode, FaceWord, Layout) %>% 
    summarize(meanResp = mean(Resp), Count = n()) %>% 
    ungroup()
}

str(df_univar_agg)
```


## Data from functional scans for CoSMoMVPA
```{r load data file from cosmoMVPA}
df_mvpa <- read_csv(fn_cosmo)

str(df_mvpa)
```

```{r clean the cosmomvpa data}
df_clean_mvpa <- {
  df_mvpa %>% 
    select(ExpCode, ROI, SubjCode, ClassifyPair, Predicted, Targets, ACC)
}

str(df_clean_mvpa)
```

```{r calculate accuracy for each condition}
df_mvpa_acc <- {
  df_clean_mvpa %>% 
    select(-c(Predicted, Targets)) %>% # remove these two columns
    group_by(ExpCode, ROI, SubjCode, ClassifyPair) %>% # divide the data into groups by these columns 
    summarize(Accuracy = mean(ACC), Count = n()) %>% 
    ungroup()
}
```

```{r descriptive analyses for mvpa}
desc_mvpa_acc <- {
  df_mvpa_acc %>% 
    group_by(ExpCode, ClassifyPair) %>% 
    summarize(emmean = mean(Accuracy), Count = n(), SE = sd(Accuracy)/sqrt(Count)) %>%
    mutate(lower.CL = lower_ci(emmean, SE, Count),
           upper.CL = upper_ci(emmean, SE, Count)) %>% 
    ungroup()
  }

```

# Experiment 1: faces and words
## Univariate analyses for localizer scans
```{r only keep the univariate data for E1 loc}
df_loc_E1 <- {
  df_clean_loc %>%  
    filter(ExpCode == 1) %>% 
    mutate(SubjCode = as.factor(SubjCode))
}
# nlevels(df_loc_E1$SubjCode) # number of subjects
```
The number of subjects included in this analysis is `r nlevels(df_loc_E1$SubjCode)`

### rm-ANOVA
```{r}
anova_loc_E1 <- aov_4(Resp ~ Conditions + (Conditions | SubjCode), data = df_loc_E1)

anova_loc_E1
```

```{r estimated marginal means for loc E1}
emm_loc_anova_E1 <- emmeans(anova_loc_E1, ~ Conditions)

emm_loc_anova_E1
```

```{r Post-hoc analysis for anova loc E1}
contrast(emm_loc_anova_E1, "pairwise")

```

### Linear mixed model
```{r lmm for E1 loc}
lmm_loc_E1 <- lmer(Resp ~ Conditions + (1 | SubjCode), data = df_loc_E1)

summary(lmm_loc_E1)
```

```{r estimated marginal means for lmm loc E1}
emm_loc_lmm_E1 <- emmeans(lmm_loc_E1, ~ Conditions)

emm_loc_lmm_E1
```

```{r comparison among levels in Conditions lmm loc E1}
contrast(emm_loc_lmm_E1, "pairwise")
```

### Plot
```{r plots for loc E1 (anova)}
plot_loc_E1 <- {
  ggplot(data = as.data.frame(emm_loc_anova_E1), aes(y = emmean, x = Conditions)) + # set the data, varialbes for x and y axises
    geom_col(position = "dodge", color = "black", alpha = .7) +  # position of columns and countour of columns
    geom_errorbar(mapping = aes(ymin = lower.CL, ymax = upper.CL), linetype = 1,  # set the error bar
                  show.legend = FALSE, width = 0.25, alpha = .5,
                  position = position_dodge(width=0.9)) +
    scale_y_continuous(expand= c(0, 0), limits = c(0, activationUL), breaks = seq(0, 3, .5)) +  # remove the space between columns and x axis
    labs(title = "", x = "Stimuli", y = "Neural Responses") +  # set the names for main, x and y axises Subjective Responses for E205
    general_theme
}

plot_loc_E1
```


## Univariate analyses for functional scans
```{r only keep the univariate data for E1}
df_univar_E1 <- {
  df_clean_univar %>% 
    filter(ExpCode == 1) %>% 
    mutate(FaceWord = factor(FaceWord, levels = facewordOrder),
           SubjCode = as.factor(SubjCode))
}
  
df_univar_agg_E1 <- {
  df_univar_agg %>% 
    filter(ExpCode == 1) %>% 
    mutate(FaceWord = factor(FaceWord, levels = facewordOrder),
           SubjCode = as.factor(SubjCode))
}

# nlevels(df_univar_E1$SubjCode) # number of subjects
```

### rm-ANOVA 
```{r anova for univariate E1}
anova_uni_E1 <- aov_4(meanResp ~ FaceWord * Layout + (1 + FaceWord * Layout | SubjCode), data = df_univar_agg_E1)

anova_uni_E1
```

```{r estimated marginal means for univairate E1}

emm_uni_anova_E1 <- emmeans(anova_uni_E1, ~ FaceWord * Layout)

emm_uni_anova_E1 %>% 
  as.data.frame() %>% 
  arrange(FaceWord)
```


```{r}
contrast(emmeans(anova_uni_E1, ~ FaceWord), "pairwise")

contrast(emmeans(anova_uni_E1, ~ Layout), "pairwise") # , adjust = "none"
```

```{r}
contrast(emm_uni_anova_E1, "pairwise", simple = "each", combine = TRUE, adjust = "none")
# contrast(emm_uni_anova_E1, interaction = "pairwise") # , adjust = "none"
```

### Linear mixed model
```{r lmm for univariate E1}

# lmm.uni.E1 <- lmer(Resp ~ FaceWord * Layout + (1 + FaceWord * Layout | SubjCode), data = df_univar_E1)


```

### Plot
```{r plots for functional scans E1 (anova)}
plot_uni_E1 <- {
  ggplot(data = as.data.frame(emm_uni_anova_E1), aes(y = emmean, x = FaceWord, fill = Layout)) + # set the data, varialbes for x and y axises
    geom_col(position = "dodge", color = "black", alpha = .7) +  # position of columns and countour of columns
    geom_errorbar(mapping = aes(ymin = lower.CL, ymax = upper.CL), linetype = 1,  # set the error bar
                  show.legend = FALSE, width = 0.25, alpha = .5,
                  position = position_dodge(width=0.9)) +
    scale_y_continuous(expand= c(0, 0), limits = c(0, activationUL), breaks = seq(0, 3, .5)) +  # remove the space between columns and x axis
    labs(title = "", x = "Stimuli", y = "Neural Responses") +  # set the names for main, x and y axises Subjective Responses for E205
    general_theme
}

plot_uni_E1
```

## Multivariate analyses for functional scans
```{r only keep the multivariate (mvpa) data for E1}
df_mvpa_E1 <- {
  df_clean_mvpa %>% 
    filter(ExpCode == 1) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E1),
           SubjCode = as.factor(SubjCode))
}

df_mvpa_acc_E1 <- {
  df_mvpa_acc %>% 
    filter(ExpCode == 1) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E1),
           SubjCode = as.factor(SubjCode))
}

# nlevels(df_mvpa_E1$SubjCode) # number of subjects
```

### One-sample t-test
```{r one-sample for results of mvpa E1}

df_mvpa_acc_E1 %>% 
  spread(ClassifyPair, Accuracy) %>% # change to table (each row is one subject)
  select(-c(ExpCode, ROI, SubjCode, Count)) %>% # remove these columns
  sapply(function(x) t.test(x, mu = 0.5, alternative = "greater")) # apply one-sample t-test to each column separately 

```

### Logistic model
```{r logistic linear model for results of mvpa E1 }

glm_mvpa_E1 <- glm(ACC ~ ClassifyPair, family = binomial, data = df_mvpa_E1)

summary(glm_mvpa_E1)
```

```{r estimated marginal means for mvpa E1}
emm_mvpa_E1 <- emmeans(glm_mvpa_E1, ~ ClassifyPair)

emm_mvpa_E1
```


```{r one-sample t-test for logistic models E1}
test(emm_mvpa_E1, mu = 0, side = ">")
```

### Plot
```{r plots for functional scans mvpa E1 (anova)}

desc_mvpa_acc_E1 <- {
  desc_mvpa_acc %>% 
    filter(ExpCode == 1) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E1))
}

plot_mvpa_E1 <- {
  ggplot(data = desc_mvpa_acc_E1, aes(y = emmean, x = ClassifyPair)) + # set the data, varialbes for x and y axises
    geom_col(position = "dodge", color = "black", alpha = .7) +  # position of columns and countour of columns
    geom_errorbar(mapping = aes(ymin = lower.CL, ymax = upper.CL), linetype = 1,  # set the error bar
                  show.legend = FALSE, width = 0.25, alpha = .5,
                  position = position_dodge(width=0.9)) +
    geom_hline(yintercept = c(0.5, 1), linetype = 5, alpha = 0.5) +  # add the line for 0.5 and 1 (y)
    scale_y_continuous(expand= c(0, 0), limits = c(0, 1.1), breaks = seq(0, 1, .25)) +  # remove the space between columns and x axis
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
    labs(title = "", x = "Stimuli", y = "Neural Responses") +  # set the names for main, x and y axises Subjective Responses for E205
    general_theme 
  # theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
}

plot_mvpa_E1
```

# Experiment 2: Chinese and English
## Univariate analyses for localizer scans
```{r only keep the univariate data for E2 loc}
df_loc_E2 <- {
  df_clean_loc %>% 
    filter(ExpCode == 2) %>% 
    mutate(SubjCode = as.factor(SubjCode))
}
# nlevels(df_loc_E2$SubjCode) # number of subjects
```

### rm-ANOVA
```{r}
anova_loc_E2 <- aov_4(Resp ~ Conditions + (Conditions | SubjCode), data = df_loc_E2)

anova_loc_E2
```

```{r estimated marginal means for loc E2}
emm_loc_anova_E2 <- emmeans(anova_loc_E2, ~ Conditions)

emm_loc_anova_E2
```

```{r Post-hoc analysis for anova loc E2}
contrast(emm_loc_anova_E2, "pairwise")
```

### Linear mixed model
```{r lmm for E2 loc}
lmm_loc_E2 <- lmer(Resp ~ Conditions + (1 | SubjCode), data = df_loc_E2)

summary(lmm_loc_E2)
```

```{r estimated marginal means for lmm loc E2}
emm_loc_lmm_E2 <- emmeans(lmm_loc_E2, ~ Conditions)

emm_loc_lmm_E2
```

```{r comparison among levels in Conditions lmm loc E2}
contrast(emm_loc_lmm_E2, "pairwise")
```

### Plot
```{r plots for loc E2 (anova)}
plot_loc_E2 <- {
  ggplot(data = as.data.frame(emm_loc_anova_E2), aes(y = emmean, x = Conditions)) + # set the data, varialbes for x and y axises
    geom_col(position = "dodge", color = "black", alpha = .7) +  # position of columns and countour of columns
    geom_errorbar(mapping = aes(ymin = lower.CL, ymax = upper.CL), linetype = 1,  # set the error bar
                  show.legend = FALSE, width = 0.25, alpha = .5,
                  position = position_dodge(width=0.9)) +
    scale_y_continuous(expand= c(0, 0), limits = c(0, activationUL), breaks = seq(0, 3, .5)) +  # remove the space between columns and x axis
    labs(title = "", x = "Stimuli", y = "Neural Responses") +  # set the names for main, x and y axises Subjective Responses for E205
    general_theme
}

plot_loc_E2
```

## Univariate analysis for functional scans
```{r only keep the univariate data for E2}

df_univar_E2<- {
  df_clean_univar %>% 
    filter(ExpCode == 2) %>% 
    mutate(FaceWord = factor(FaceWord, levels = wordsOrder),
           SubjCode = as.factor(SubjCode))
}
  
df_univar_agg_E2<- {
  df_univar_agg %>% 
    filter(ExpCode == 2) %>% 
    mutate(FaceWord = factor(FaceWord, levels = wordsOrder),
           SubjCode = as.factor(SubjCode))
}

# nlevels(df_univar_E2$SubjCode) # number of subjects
```

### rm-ANOVA 
```{r anova for univariate E2}
anova_uni_E2 <- aov_4(meanResp ~ FaceWord * Layout + (1 + FaceWord * Layout | SubjCode), data = df_univar_agg_E2)

anova_uni_E2
```

```{r estimated marginal means for univairate E2}

emm_uni_anova_E2 <- emmeans(anova_uni_E2, ~ FaceWord * Layout)

emm_uni_anova_E2 %>% 
  as.data.frame() %>% 
  arrange(FaceWord)
```

```{r}
# contrast(emm_uni_anova_E2, "pairwise")
# 
# contrast(emm_uni_anova_E2, interaction = "pairwise")

contrast(emm_uni_anova_E2, "pairwise", simple = "each", combine = TRUE, adjust = "none")
```

### Plot
```{r plots for functional scans E2 (anova)}
plot_uni_E2 <- {
  ggplot(data = as.data.frame(emm_uni_anova_E2), aes(y = emmean, x = FaceWord, fill = Layout)) + # set the data, varialbes for x and y axises
    geom_col(position = "dodge", color = "black", alpha = .7) +  # position of columns and countour of columns
    geom_errorbar(mapping = aes(ymin = lower.CL, ymax = upper.CL), linetype = 1,  # set the error bar
                  show.legend = FALSE, width = 0.25, alpha = .5,
                  position = position_dodge(width=0.9)) +
    scale_y_continuous(expand= c(0, 0), limits = c(0, activationUL), breaks = seq(0, 3, .5)) +  # remove the space between columns and x axis
    labs(title = "", x = "Stimuli", y = "Neural Responses") +  # set the names for main, x and y axises Subjective Responses for E205
    general_theme
}

plot_uni_E2
```

## Multivariate analyses for functional scans
```{r only keep the multivariate (mvpa) data for E2}

df_mvpa_E2 <- {
  df_clean_mvpa %>% 
    filter(ExpCode == 2) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E2),
           SubjCode = as.factor(SubjCode))
}

df_mvpa_acc_E2 <- {
  df_mvpa_acc %>% 
    filter(ExpCode == 2) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E2),
           SubjCode = as.factor(SubjCode))
}

# nlevels(df_mvpa_E2$SubjCode) # number of subjects
```

### One-sample t-test
```{r one-sample for results of mvpa E2}

df_mvpa_acc_E2 %>% 
  spread(ClassifyPair, Accuracy) %>% 
  select(-c(ExpCode, ROI, SubjCode, Count)) %>% 
  sapply(function(x) t.test(x, mu = 0.5, alternative = "greater"))

```

### Logistic model
```{r logistic linear model for results of mvpa E2 }

glm_mvpa_E2 <- glm(ACC ~ ClassifyPair, family = binomial, data = df_mvpa_E2)

summary(glm_mvpa_E2)
```

```{r estimated marginal means for mvpa E2}
emm_mvpa_E2 <- emmeans(glm_mvpa_E2, ~ ClassifyPair)

emm_mvpa_E2
```


```{r one-sample t-test for logistic models E2}
test(emm_mvpa_E2, mu = 0, side = ">")
```


```{r}
# glm_mvpa_E2_1 <- glm(ACC ~ 1, family = binomial, data = filter(df_mvpa_E2, ClassifyPair == levels(df_mvpa_E2$ClassifyPair)[5]))
# 
# # summary(glm_mvpa_E2_1)
# 
# emm_mvpa_E2_1 <- emmeans(glm_mvpa_E2_1, ~ 1)
# 
# test(emm_mvpa_E2_1, null = 0, side = ">")
```


### Plot
```{r plots for functional scans mvpa E2 (anova)}

desc_mvpa_acc_E2 <- {
  desc_mvpa_acc %>% 
    filter(ExpCode == 2) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E2))
}

plot_mvpa_E2 <- {
  ggplot(data = desc_mvpa_acc_E2, aes(y = emmean, x = ClassifyPair)) + # set the data, varialbes for x and y axises
    geom_col(position = "dodge", color = "black", alpha = .7) +  # position of columns and countour of columns
    geom_errorbar(mapping = aes(ymin = lower.CL, ymax = upper.CL), linetype = 1,  # set the error bar
                  show.legend = FALSE, width = 0.25, alpha = .5,
                  position = position_dodge(width=0.9)) +
    geom_hline(yintercept = c(0.5, 1), linetype = 5, alpha = 0.5) +  # add the line for 0.5 and 1 (y)
    scale_y_continuous(expand= c(0, 0), limits = c(0, 1.1), breaks = seq(0, 1, .25)) +  # remove the space between columns and x axis
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
    labs(title = "", x = "Stimuli", y = "Neural Responses") +  # set the names for main, x and y axises Subjective Responses for E205
    general_theme 
  # theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
}

plot_mvpa_E2
```

# Versions of packages used
```{r versions}
# rstudioapi::versionInfo()
sessionInfo()
```
