---
title: "Face Word Projects -- Data Analysis"
author: "[Haiyang Jin](https://haiyangjin.github.io/)"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output:
  html_document:
    df_print: paged
    number_sections: true
    toc: true
    toc_depth: 4
    toc_float: 
      collapsed: true
      smooth_scroll: false
    includes:
      after_body: Utilities/footer.html
---

# Preparations
```{r preparation}
# load library
library(tidyverse)
library(afex)
library(lme4)
library(lmerTest)
library(emmeans)

```

# Load and clean data 
```{r assign filenames}
# assign filenames
fn_univar <- "FaceWord_Uni.csv"
fn_cosmo <- "FaceWord_Cosmo.csv"

# set the order of levels in factors
facewordOrder <- c("face", "word")
wordsOrder <- c("Chinese", "English")
layoutOrder <- c("intact", "exchange", "top", "bottom")

pairOrder_E1 <- c("face_intact-word_intact",
                  "face_intact-face_exchange",
                  "face_top-face_bottom",
                  "word_intact-word_exchange",
                  "word_top-word_bottom")
pairOrder_E2 <- c("Chinese_intact-English_intact",
                  "Chinese_intact-Chinese_exchange",
                  "Chinese_top-Chinese_bottom",
                  "English_intact-English_exchange",
                  "English_top-English_bottom")

```

## Data for univarite analysis
```{r load data file for univariate analysis}
# load data file for univerate analysis
df_univar <- read.csv(fn_univar)

str(df_univar)
```

```{r clean the univariate data}
df_clean_univar <- {
  df_univar %>% 
    separate(Conditions, c("FaceWord", "Layout"), "_") %>% # separate the conditions into two IVs
    mutate(# FaceWord = as.factor(FaceWord),
           Layout = factor(Layout, levels = layoutOrder)) %>% # convert the two IVs to factors
    select(ExpCode, ROI, SubjCode, FaceWord, Layout, Resp) 
}

str(df_clean_univar)
```

```{r aggregate data for anova}
df_univar_agg <- {
  df_clean_univar %>% 
    group_by(ExpCode, ROI, SubjCode, FaceWord, Layout) %>% 
    summarize(meanResp = mean(Resp), Count = n()) %>% 
    ungroup()
}

str(df_univar_agg)
```


## Data from CoSMoMVPA
```{r load data file from cosmoMVPA}
df_mvpa <- read.csv(fn_cosmo)

str(df_mvpa)
```

```{r clean the cosmomvpa data}
df_clean_mvpa <- {
  df_mvpa %>% 
    select(ExpCode, ROI, SubjCode, ClassifyPair, Predicted, Targets, ACC)
}

str(df_clean_mvpa)
```

```{r calculate accuracy for each condition}
df_mvpa_acc <- {
  df_clean_mvpa %>% 
    select(-c(Predicted, Targets)) %>% # remove these two columns
    group_by(ExpCode, ROI, SubjCode, ClassifyPair) %>% # divide the data into groups by these columns 
    summarize(Accuracy = mean(ACC), Count = n()) %>% 
    ungroup()
}
```

# ROI information
```{r roi information}
df_univar %>% 
  select(ExpCode, ROI, SubjCode, nVertices, LabelSize) %>% 
  distinct()
```

# Experiment 1: faces and words
## Univariate analyses
```{r only keep the univariate data for E1}
df_univar_E1 <- {
  df_clean_univar %>% 
    filter(ExpCode == 1) %>% 
    mutate(FaceWord = factor(FaceWord, levels = facewordOrder))
}
  
df_univar_agg_E1 <- {
  df_univar_agg %>% 
    filter(ExpCode == 1) %>% 
    mutate(FaceWord = factor(FaceWord, levels = facewordOrder))
}


```

### rm-ANOVA 
```{r anova for univariate E1}
anova_uni_E1 <- aov_4(meanResp ~ FaceWord * Layout + (1 + FaceWord * Layout | SubjCode), data = df_univar_agg_E1)

summary(anova_uni_E1)
```

```{r estimated marginal means for univairate E1}

emm_uni_E1 <- emmeans(anova_uni_E1, ~ FaceWord * Layout)

emm_uni_E1
```


```{r}
# contrast(emmeans(anova_uni_E1, ~ FaceWord), "pairwise")
#  
# contrast(emmeans(anova_uni_E1, ~ Layout), "pairwise", adjust = "none")
```

```{r}
contrast(emm_uni_E1, interaction = "pairwise", adjust = "none")
```

### Linear mixed model
```{r lmm for univariate E1}

# lmm.uni.E1 <- lmer(Resp ~ FaceWord * Layout + (1 + FaceWord * Layout | SubjCode), data = df_univar_E1)


```

## Multivariate analyses
```{r only keep the multivariate (mvpa) data for E1}
df_mvpa_E1 <- {
  df_clean_mvpa %>% 
    filter(ExpCode == 1) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E1))
}

df_mvpa_acc_E1 <- {
  df_mvpa_acc %>% 
    filter(ExpCode == 1) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E1))
}

```

### One-sample t-test
```{r one-sample for results of mvpa E1}

df_mvpa_acc_E1 %>% 
  spread(ClassifyPair, Accuracy) %>% # change to table (each row is one subject)
  select(-c(ExpCode, ROI, SubjCode, Count)) %>% # remove these columns
  sapply(function(x) t.test(x, mu = 0.5, alternative = "greater")) # apply one-sample t-test to each column separately 

```


### Logistic model
```{r logistic linear model for results of mvpa E1 }

glm_mvpa_E1 <- glm(ACC ~ ClassifyPair, family = binomial, data = df_mvpa_E1)

summary(glm_mvpa_E1)
```

```{r estimated marginal means for mvpa E1}
emm_mvpa_E1 <- emmeans(glm_mvpa_E1, ~ ClassifyPair)

emm_mvpa_E1
```


```{r one-sample t-test for logistic models E1}
test(emm_mvpa_E1, mu = 0, side = ">")
```

# Experiment 2: Chinese and English
## Univariate analysis
```{r only keep the univariate data for E2}

df_univar_E2<- {
  df_clean_univar %>% 
    filter(ExpCode == 2) %>% 
    mutate(FaceWord = factor(FaceWord, levels = wordsOrder))
}
  
df_univar_agg_E2<- {
  df_univar_agg %>% 
    filter(ExpCode == 2) %>% 
    mutate(FaceWord = factor(FaceWord, levels = wordsOrder))
}

```

### rm-ANOVA 
```{r anova for univariate E2}
anova_uni_E2 <- aov_4(meanResp ~ FaceWord * Layout + (1 + FaceWord * Layout | SubjCode), data = df_univar_agg_E2)

summary(anova_uni_E2)
```

```{r estimated marginal means for univairate E2}

emm_uni_E2 <- emmeans(anova_uni_E2, ~ FaceWord * Layout)

emm_uni_E2
```

```{r}
# contrast(emm_uni_E2, "pairwise")
# 
# contrast(emm_uni_E2, interaction = "pairwise")
```


## Multivariate analyses
```{r only keep the multivariate (mvpa) data for E2}

df_mvpa_E2 <- {
  df_clean_mvpa %>% 
    filter(ExpCode == 2) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E2))
}

df_mvpa_acc_E2 <- {
  df_mvpa_acc %>% 
    filter(ExpCode == 2) %>% 
    mutate(ClassifyPair = factor(ClassifyPair, levels = pairOrder_E2))
}
```

### One-sample t-test
```{r one-sample for results of mvpa E2}

df_mvpa_acc_E2 %>% 
  spread(ClassifyPair, Accuracy) %>% 
  select(-c(ExpCode, ROI, SubjCode, Count)) %>% 
  sapply(function(x) t.test(x, mu = 0.5, alternative = "greater"))

```


### Logistic model
```{r logistic linear model for results of mvpa E2 }

glm_mvpa_E2 <- glm(ACC ~ ClassifyPair, family = binomial, data = df_mvpa_E2)

summary(glm_mvpa_E2)
```

```{r estimated marginal means for mvpa E2}
emm_mvpa_E2 <- emmeans(glm_mvpa_E2, ~ ClassifyPair)

emm_mvpa_E2
```


```{r one-sample t-test for logistic models E2}
test(emm_mvpa_E2, mu = 0, side = ">")
```

# Versions of packages used
```{r versions}
# rstudioapi::versionInfo()
sessionInfo()
```
